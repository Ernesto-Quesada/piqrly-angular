<!-- viewpic.component.html -->
<div class="qr-page container-fluid px-0">
  <!-- TOP HEADER (does NOT depend on owner/forSale) -->
  <div class="top-card">
    <div class="top-row">
      <div class="top-left">
        <!-- Title -->
        <div class="top-title">
          <ng-container *ngIf="inviteCode; else qrTitle">
            {{ (eventName ?? "").trim() || "Event Photos" }}
          </ng-container>

          <!-- ✅ FIX: do NOT gate title behind "forSale$ | async as forSale"
               because it can be null/undefined on first render and shows nothing. -->
          <ng-template #qrTitle>
            {{ (forSale$ | async) ? "Photos for Sale" : "Free Download" }}
          </ng-template>
        </div>

        <!-- PRIVATE EVENT BLOCK (works even if owner is null) -->
        <div class="private-block" *ngIf="(isPrivateEvent$ | async) === true">
          <div class="top-hint warn">
            This event is private. Please login or create an account to
            continue.
          </div>

          <button
            mat-raised-button
            class="btn-primary small"
            type="button"
            (click)="goToLogin()"
          >
            Login / Create account
          </button>
        </div>

        <!-- NORMAL HEADER CONTENT (only when NOT private) -->
        <ng-container *ngIf="(isPrivateEvent$ | async) === false">
          <!-- Creator (only if owner exists) -->
          <ng-container *ngIf="owner$ | async as owner">
            <div class="top-sub">
              <span class="label">Creator</span>
              <span class="value">
                {{ owner.firstName || "" }} {{ owner.lastName || "" }}
              </span>
            </div>

            <!-- Contact ONLY when free -->
            <div class="top-sub contact" *ngIf="!(forSale$ | async)">
              <span *ngIf="owner.email" class="contact-item">
                <mat-icon class="mini">mail</mat-icon>
                {{ owner.email }}
              </span>

              <span *ngIf="owner.phone" class="contact-item">
                <mat-icon class="mini">call</mat-icon>
                {{ owner.phone }}
              </span>
            </div>
          </ng-container>

          <!-- ✅ SINGLE hint line (no duplicates) -->
          <!-- RULE: For QR flow + free, do NOT show an extra "free previews" hint here
               because the sticky "Free download" card already communicates it.
               For EVENT flow, we still show the hint here because events can be locked. -->
          <div class="top-hint" *ngIf="!!inviteCode">
            {{
              (forSale$ | async)
                ? "These photos are for sale."
                : downloadLocked
                  ? "You can preview photos. Login to download."
                  : "Free previews now. Download available."
            }}
          </div>
        </ng-container>
      </div>

      <!-- Avatar (only when owner exists and not private) -->
      <div class="top-right" *ngIf="(isPrivateEvent$ | async) === false">
        <ng-container *ngIf="owner$ | async as owner">
          <div class="mini-avatar" *ngIf="!owner.profilePic">
            <mat-icon>person</mat-icon>
          </div>

          <img
            *ngIf="owner.profilePic"
            class="mini-avatar-img"
            [src]="owner.profilePic"
            alt="Creator avatar"
          />
        </ng-container>
      </div>
    </div>
  </div>

  <!-- DOWNLOAD LOCKED (free download already used) -->
  <div class="private-block" *ngIf="downloadLocked">
    <div class="top-hint warn">{{ downloadLockedMsg }}</div>

    <button
      mat-raised-button
      class="btn-primary small"
      type="button"
      (click)="goToLogin()"
    >
      Login / Create account
    </button>
  </div>

  <!-- Everything below hidden when private -->
  <ng-container *ngIf="(isPrivateEvent$ | async) === false">
    <!-- ===========================================================
         HERO / ACTION PANEL
         RULES YOU ASKED:
         1) If QR flow AND free → show only ONE card (Free download) and NO Select button
         2) Select/Clear is allowed for:
            - Paid (QR + Event)
            - Free EVENT (inviteCode) so users can choose pictures for download
         =========================================================== -->

    <!-- ✅ HERO only when:
         - forSale is true OR
         - (free AND inviteCode AND not locked)  (event free selection)
         We do NOT show hero for free QR flow. -->
    <div
      class="hero"
      *ngIf="(forSale$ | async) || (!!inviteCode && !downloadLocked)"
    >
      <div class="row mb-1">
        <div class="col">
          <div class="hero-hint">
            <ng-container *ngIf="selectMode; else notSelectMode">
              <ng-container *ngIf="forSale$ | async; else selectFree">
                Select size and tap photos to add/remove from cart.
              </ng-container>

              <ng-template #selectFree>
                Tap photos to select for download.
              </ng-template>
            </ng-container>

            <ng-template #notSelectMode>
              <ng-container *ngIf="forSale$ | async; else freeFlow">
                <span class="hint-muted">
                  Use Select to add to your cart or tap on a picture
                </span>
              </ng-container>

              <ng-template #freeFlow>
                <span class="hint-strong">Tap Select to choose photos.</span>
              </ng-template>
            </ng-template>
          </div>
        </div>
      </div>

      <div class="row g-2">
        <!-- ✅ Select button shown ONLY for:
             - Paid (any flow)
             - Free EVENT flow (inviteCode)
             NOT shown for Free QR flow -->
        <div
          class="col-12 col-md-auto"
          *ngIf="(forSale$ | async) || !!inviteCode"
        >
          <button
            type="button"
            mat-stroked-button
            class="btn-pill btn-secondary w-100"
            (click)="onSelectOrClear()"
          >
            <mat-icon>
              {{ selectedCount > 0 ? "delete_outline" : "check_circle" }}
            </mat-icon>
            {{ selectedCount > 0 ? "Clear selection" : "Select" }}
          </button>
        </div>
      </div>

      <!-- ✅ Size pills only for paid -->
      <div class="row mt-2" *ngIf="forSale$ | async">
        <div class="col-12">
          <div class="d-flex flex-wrap gap-1">
            <button
              mat-stroked-button
              class="btn-pill w-auto"
              (click)="setSize('small')"
              [class.active-pill]="selectedSize === 'small'"
            >
              Small
              <span class="ms-1 price-chip" *ngIf="prices$ | async as p">
                {{ p.priceSmall | currency }}
              </span>
            </button>

            <button
              mat-stroked-button
              class="btn-pill w-auto"
              (click)="setSize('full')"
              [class.active-pill]="selectedSize === 'full'"
            >
              Full
              <span class="ms-1 price-chip" *ngIf="prices$ | async as p">
                {{ p.priceFull | currency }}
              </span>
            </button>

            <button
              mat-stroked-button
              class="btn-pill w-auto"
              (click)="setSize('royalty')"
              [class.active-pill]="selectedSize === 'royalty'"
            >
              Royalty
              <span class="ms-1 price-chip" *ngIf="prices$ | async as p">
                {{ p.priceRoyalty | currency }}
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="images$ | async as images" class="subtitle p-2">
      Scan complete • Tap to view
    </div>

    <!-- GRID ALWAYS STAYS -->
    <div class="grid" *ngIf="images$ | async as images">
      <button
        class="img-card mat-elevation-z2"
        *ngFor="let img of images; let i = index"
        (click)="openPreview(img, i)"
        type="button"
      >
        <img [src]="img.previewImageUrl" alt="preview" />

        <!-- ✅ Selection overlay shown ONLY when selectMode is ON.
             (QR free flow never enables selectMode now because there’s no Select button.) -->
        <div class="img-overlay" *ngIf="selectMode$ | async">
          <div class="d-flex align-items-center gap-2">
            <mat-icon class="check size" *ngIf="isInCart(img.pictureId)">
              check_circle
            </mat-icon>
            <mat-icon class="check muted" *ngIf="!isInCart(img.pictureId)">
              radio_button_unchecked
            </mat-icon>

            <!-- size badge only meaningful for paid -->
            <span
              class="size-badge"
              *ngIf="(forSale$ | async) && isInCart(img.pictureId)"
            >
              {{ cartSizeLabel(img.pictureId) }}
            </span>
          </div>
        </div>
      </button>
    </div>

    <!-- ===========================================================
         STICKY BAR
         RULES YOU ASKED:
         - QR free: show ONLY ONE “Free download” sticky (no hero, no select)
         - Event free: keep selection capability + respect lock
         - Paid: checkout requires selection count > 0
         =========================================================== -->

    <!-- ✅ Show sticky when:
         - Paid (always)
         - Free QR flow (always)  -> NOT locked concept
         - Free Event flow only if not locked -->
    <div
      class="sticky"
      *ngIf="
        (forSale$ | async) ||
        (!inviteCode && !(forSale$ | async)) ||
        (!!inviteCode && !(forSale$ | async) && !downloadLocked)
      "
    >
      <div class="sticky-info">
        <!-- ✅ Title -->
        <div class="sticky-title">
          <!-- Paid -->
          <ng-container *ngIf="forSale$ | async; else freeStickyTitle">
            {{ selectMode ? selectedCount + " selected" : "For sale" }}
          </ng-container>

          <!-- Free -->
          <ng-template #freeStickyTitle>
            <!-- QR free: always “Free download” -->
            <ng-container *ngIf="!inviteCode; else eventFreeTitle">
              Free download
            </ng-container>
            <!-- Event free: show selection count when selecting -->
            <ng-template #eventFreeTitle>
              {{ selectMode ? selectedCount + " selected" : "Free download" }}
            </ng-template>
          </ng-template>
        </div>

        <!-- ✅ Subtitle -->
        <div class="sticky-sub">
          <ng-container *ngIf="forSale$ | async; else freeStickySub">
            {{
              selectMode
                ? "Tap photos to add/remove"
                : "High-res purchase available"
            }}
          </ng-container>

          <ng-template #freeStickySub>
            <!-- QR free: no select → always zip all -->
            <ng-container *ngIf="!inviteCode; else eventFreeSub">
              A zip file with all pics will be downloaded
            </ng-container>

            <!-- Event free: selection supported -->
            <ng-template #eventFreeSub>
              {{
                selectMode
                  ? "Tap photos to select"
                  : "A zip file with pics will be downloaded"
              }}
            </ng-template>
          </ng-template>
        </div>
      </div>

      <!-- FREE Download button:
           - QR free: always enabled (no selection needed)
           - Event free: disabled only when in selectMode and nothing selected -->
      <button
        *ngIf="!(forSale$ | async)"
        mat-raised-button
        class="btn-primary small"
        (click)="downloadSelected()"
        [disabled]="!!inviteCode && selectMode && selectedCount === 0"
      >
        Download
        {{ !!inviteCode && selectMode ? "(" + selectedCount + ")" : "" }}
      </button>

      <!-- PAID Checkout button:
           must be disabled when no items (always) -->
      <button
        type="button"
        *ngIf="forSale$ | async"
        mat-raised-button
        class="btn-primary small"
        (click)="goToCheckout()"
        [disabled]="selectedCount === 0"
      >
        Checkout {{ selectMode ? "(" + selectedCount + ")" : "" }}
      </button>
    </div>
  </ng-container>
</div>
