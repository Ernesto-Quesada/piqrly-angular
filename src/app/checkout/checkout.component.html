<div *ngIf="cartId" class="alert alert-info mt-3">
  Checkout for app cart: <strong>{{ cartId }}</strong>
</div>
<!-- ðŸ”™ Back to photos -->
<button
  type="button"
  class="back-to-photos-btn"
  (click)="goBackToViewPics()"
  aria-label="Back to photos"
>
  <mat-icon class="back-icon">chevron_left</mat-icon>
  <span class="back-text">Back to photos</span>
</button>

<div class="container-fluid d-flex flex-column h-100">
  <div class="card mt-5 mb-4">
    <div class="card-body">
      <h6 class="card-title mb-3">Checkout</h6>

      <form [formGroup]="checkoutForm" (ngSubmit)="pay($event)">
        <div class="row">
          <div class="col-md-6">
            <div class="form-floating mb-3">
              <input
                formControlName="fullName"
                type="text"
                class="form-control"
                id="fname"
                placeholder="Enter Name here"
              />
              <label class="d-flex" for="fname">
                <mat-icon class="me-2">person_outline</mat-icon>
                <span class="border-start border-info ps-3">Name</span>
              </label>
            </div>
          </div>

          <div class="col-md-6">
            <div class="form-floating mb-3">
              <input
                formControlName="email"
                type="email"
                class="form-control"
                id="tb-email"
                placeholder="email@example.com"
              />
              <label class="d-flex" for="tb-email">
                <span class="material-icons-outlined me-2"> email </span>
                <span class="border-start border-info ps-3">Email</span>
              </label>
            </div>
          </div>

          <div class="row ms-0">
            <div class="col-8">
              <p class="">item total</p>
            </div>
            <div class="col-4">
              <p class="text-end co-font-size">
                {{ itemTotals.itemTotal }} items
              </p>
            </div>
          </div>

          <div class="row ms-0 mb-3" *ngIf="itemTotals.fullSizeItems > 0">
            <div class="col-8">
              <p class="mb-0 lineh1">
                full size pictures
                <span class="co-font-size">{{ itemTotals.fullSizeItems }}</span>
              </p>
              <span class="price-each">
                {{ itemTotals.fullSizePriceEach | currency }}each
              </span>
              <span class="price-each bkg-i">best for prints</span>
            </div>
            <div class="col-4">
              <p class="text-end sub-font-size">
                {{ itemTotals.fullSizeSubT | currency }}
              </p>
            </div>
          </div>

          <div class="row ms-0 mb-3" *ngIf="itemTotals.smallItems > 0">
            <div class="col-8">
              <p class="mb-0 lineh1">
                small size pictures
                <span class="co-font-size">{{ itemTotals.smallItems }}</span>
              </p>
              <span class="price-each">
                {{ itemTotals.smallSizePriceEach | currency }}each
              </span>
              <span class="price-each bkg-i">best for social media</span>
            </div>
            <div class="col-4">
              <p class="text-end sub-font-size">
                {{ itemTotals.smallSizeSubT | currency }}
              </p>
            </div>
          </div>

          <!-- âœ… Royalty block -->
          <div class="row ms-0 mb-3" *ngIf="itemTotals.royaltyItems > 0">
            <div class="col-8">
              <p class="mb-0 lineh1">
                royalty pictures
                <span class="co-font-size">{{ itemTotals.royaltyItems }}</span>
              </p>
              <span class="price-each">
                {{ itemTotals.royaltyPriceEach | currency }}each
              </span>
              <span class="price-each bkg-i">commercial use</span>
            </div>
            <div class="col-4">
              <p class="text-end sub-font-size">
                {{ itemTotals.royaltySubT | currency }}
              </p>
            </div>
          </div>

          <p class="total text-end sub-font-size">
            Total: {{ itemTotals.grandTotal | currency }}
          </p>

          <div class="col-12">
            <div class="d-md-flex align-items-center">
              <div class="d-grid gap-2 col-8 mx-auto mt-3">
                <button
                  mat-raised-button
                  type="submit"
                  [ngClass]="
                    checkoutForm.invalid
                      ? 'disabledCheckoutColor'
                      : 'enabledCheckout'
                  "
                  [disabled]="checkoutForm.invalid"
                >
                  Pay Now
                </button>
              </div>
              <span class="text-center" style="font-size: 9px; display: block"
                >Powered by STRIPE</span
              >
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- âœ… Back to ViewPics (always available) -->
  <div class="d-flex align-items-center mb-2">
    <button
      type="button"
      class="btn btn-link p-0 me-2 back-btn"
      (click)="goBackToViewPics()"
      aria-label="Back to photos"
    >
      <mat-icon>chevron_left</mat-icon>
    </button>

    <span class="small text-muted">Back to photos</span>
  </div>

  <!-- âœ… ONE rendering path (no duplicates) -->
  <ng-container *ngIf="cartId; else qrFlow">
    <div class="row g-2 checkout-grid">
      <div class="col-6 col-lg-3" *ngFor="let item of webCartItems">
        <div class="card checkout-item-card">
          <div class="d-flex align-items-center p-2 gap-2">
            <img
              [src]="getCheckoutThumb(item)"
              (error)="onThumbError($event)"
              class="checkout-thumb"
              alt="thumbnail"
              loading="lazy"
            />

            <div class="flex-grow-1">
              <div class="line1">{{ item.size }} size</div>
              <div class="line2">{{ item.price | currency }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-template #qrFlow>
    <div class="row g-2 checkout-grid">
      <div
        class="col-6 col-lg-3"
        *ngFor="let image of (selectedImages$ | async) ?? []"
      >
        <div class="card checkout-item-card">
          <div class="d-flex align-items-center p-2 gap-2">
            <img
              [src]="getCheckoutThumb(image)"
              (error)="onThumbError($event)"
              class="checkout-thumb"
              alt="thumbnail"
              loading="lazy"
            />

            <div class="flex-grow-1">
              <div class="line1">{{ image.size }} size</div>
              <div class="line2">{{ image.price | currency }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-template>
</div>
